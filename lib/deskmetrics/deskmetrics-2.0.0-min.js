!function(){var deskMetricsFactory=function(_window,_XMLHttpRequest){function enableConsoleOutput(enabled){_console=enabled?_window.console:_nullConsole}function generateClientUid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})}function merge(){for(var key,obj={},i=0,il=arguments.length;il>i;i++)for(key in arguments[i])arguments[i].hasOwnProperty(key)&&(obj[key]=arguments[i][key]);return obj}function getTimestamp(callback){var timeRequest=new _XMLHttpRequest;timeRequest.open("GET","https://analytics.pingstatsnet.com/time"),timeRequest.onreadystatechange=function(){4==timeRequest.readyState&&callback(200==timeRequest.status?Math.round(parseInt(timeRequest.responseText)/1e3):0)},timeRequest.send()}function start(options,callback){return _calledStart||_didStart?void _console.error("DeskMetrics is already started."):options&&options.appId?(_calledStart=!0,_options=merge(_options,options),_startCallback=callback,_sessionProps.user_agent=_window.navigator.userAgent,_sessionProps.ua="${is.ua:user_agent}",_sessionProps.ip_address="${is.meta:request_ip}",_sessionProps.geo="${is.meta:request_geo}",_sessionProps.version="",_isExtension()&&(_sessionProps.version=_window.chrome.runtime.getManifest().version),_propsLoaded?_doStart():_loadProps(_options.propertyKey,function(result){result?(_propsLoaded||(_props=merge(_props,result)),_propsLoaded=!0,_doStart()):_isExtension()?_window.setTimeout(function(){_propsLoaded=!0,_doStart()},1e3):getTimestamp(function(ts){var props={};props.client_uid=generateClientUid(),props.install_time=ts||Math.floor(Date.now()/1e3),props.cohort="${is.cohort:install_time}",_propsLoaded||(_props=merge(_props,props)),_propsLoaded=!0,_doStart()})}),send("heart_beat",{}),void _window.setInterval(function(){sendEvent("heart_beat",{})},432e5)):void _console.error("appId is a required option.")}function getProperty(name){return _props[name]}function setProperty(name,value){_props[name]=value,_saveProps(_options.propertyKey,_props)}function send(name,data,requestDone){return name?(_eventQueue.push([name,"object"==typeof data?data:{},"function"==typeof data?data:requestDone]),void _processEvents()):void _console.error("Event name is required")}function _isExtension(){return"object"==typeof _window.chrome&&"object"==typeof _window.chrome.runtime&&"function"==typeof _window.chrome.runtime.getManifest&&"object"==typeof _window.chrome.runtime.getManifest()}function _processEvents(){if(_didStart&&_options.appId&&!_sending&&0!==_eventQueue.length){_sending=!0;var item=_eventQueue.shift();_sendImmediate(item[0],item[1],function(xhr){item[2]&&item[2](xhr),_sending=!1,_window.setTimeout(_processEvents,0)})}}function _sendImmediate(name,data,requestDone){var r=new _XMLHttpRequest;r.open("POST","https://analytics.pingstatsnet.com/v1/projects/"+_options.appId+"/events/"+encodeURIComponent(name)+"/",!0),r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){4==r.readyState&&(_console.debug("Done sending:",name),requestDone(r))},_console.debug("Sending:",name),r.send(JSON.stringify(merge(_sessionProps,_props,data)))}function _doStart(){_calledStart&&_propsLoaded&&!_didStart&&(_didStart=!0,_saveProps(_options.propertyKey,_props),_startCallback&&"function"==typeof _startCallback&&_startCallback(),_processEvents(),_console.log("DeskMetrics is ready to send events!"),_console.log(_props))}function _getCookie(cname){for(var name=cname+"=",ca=_window.document.cookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "===c.charAt(0);)c=c.substring(1);if(0===c.indexOf(name))return c.substring(name.length,c.length)}return""}function _setCookie(cname,cvalue,exdays){var d=new Date;d.setTime(d.getTime()+24*exdays*60*60*1e3);var expires="expires="+d.toUTCString();_window.document.cookie=cname+"="+cvalue+"; "+expires}function _loadProps(key,callback){callback=callback||function(){};try{var props=null;try{var s=_getCookie(key);s&&(props=merge(props,JSON.parse(s)))}catch(e){}try{var s=_window.localStorage.getItem(key);s&&(props=merge(props,JSON.parse(s)))}catch(e){}_isExtension()?_window.chrome.storage.local.get(key,function(items){items&&items[key]&&(props=merge(props,items[key])),callback(props)}):callback(props)}catch(e){callback()}}function _saveProps(key,props,callback){callback=callback||function(){};try{var s=JSON.stringify(props);if(_setCookie(key,s,1e3),_window.localStorage.setItem(key,s),_isExtension()){var obj={};obj[key]=props,_window.chrome.storage.local.set(obj,callback)}else callback()}catch(e){callback()}}function _loadPropsLocalStorageEx(domain,key,callback){callback=callback||function(){};try{_window.chrome.tabs.query({url:"*://*."+domain+"/*"},function(tabs){if(tabs.length>0)for(var remaining=tabs.length,props={},i=tabs.length;i>0;i--)_window.chrome.tabs.executeScript(tabs[i-1].id,{code:'localStorage.getItem("'+key+'");'},function(results){for(var j=0;j<results.length;j++)props=merge(props,JSON.parse(results[j])),_console.log("Got "+key+" properties from "+domain+" _window.localStorage.");--remaining,0>=remaining&&callback(props)});else callback()})}catch(e){_console.error("Error: failed to get "+key+" properties from "+domain+" _window.localStorage.",e),callback()}}function _loadPropsCookieEx(domain,key,callback){callback=callback||function(){};try{_window.chrome.cookies.getAll({domain:domain,name:key},function(cookieArray){for(var props={},i=0;i<cookieArray.length;i++)props=merge(props,JSON.parse(cookieArray[i].value)),_console.log("Got "+key+" properties from "+domain+" cookie.");callback(props)})}catch(e){_console.error("Error: failed to get "+key+" properties from "+domain+" cookie.",e),callback()}}var _options={propertyKey:"deskmetrics.properties",landingPageDomain:null,landingPagePropertyKey:"deskmetrics.properties"},_calledStart=!1,_propsLoaded=!1,_didStart=!1,_startCallback=null,_props={},_sessionProps={},_eventQueue=[],_sending=!1;_window=_window||window,_XMLHttpRequest=_XMLHttpRequest||XMLHttpRequest;var _nullConsole={assert:function(){},log:function(){},warn:function(){},error:function(){},debug:function(){},info:function(){}},_console=_window.console||_nullConsole;return _isExtension()&&_window.chrome.runtime.onInstalled.addListener(function(details){"install"==details.reason?(getTimestamp(function(ts){var props={};props.client_uid=generateClientUid(),props.install_time=ts||Math.floor(Date.now()/1e3),props.cohort="${is.cohort:install_time}",_loadPropsCookieEx(_options.landingPageDomain,_options.landingPagePropertyKey,function(result){result&&(props=merge(props,result)),_loadPropsLocalStorageEx(_options.landingPageDomain,_options.landingPagePropertyKey,function(result){result&&(props=merge(props,result)),_propsLoaded||(_props=merge(_props,props)),_propsLoaded=!0,_doStart()})})}),send("install",{state:"succeeded"})):"update"==details.reason&&send("update",{})}),{enableConsoleOutput:enableConsoleOutput,generateClientUid:generateClientUid,merge:merge,getTimestamp:getTimestamp,start:start,getProperty:getProperty,setProperty:setProperty,send:send}};"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=deskMetricsFactory:"function"==typeof define&&define.amd?define([],function(){return deskMetricsFactory(window,XMLHttpRequest)}):window.$dm=deskMetricsFactory(window,XMLHttpRequest)}();